<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款客户管理系统 - 客户详情</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="/">贷款CRM系统</a>
            <ul class="navbar-nav">
                <li><a href="/">首页</a></li>
                <li><a href="/customers">客户列表</a></li>
                <li><a href="/customers/add">添加客户</a></li>
                <th:block th:if="${currentUser.role.name() == 'ADMIN'}">
                    <li><a href="/admin/users">员工管理</a></li>
                    <li><a href="/customer-pool">客户公海</a></li>
                </th:block>
                <li>
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="logout-btn">退出登录</button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <div class="form-container">
            <h3>客户详情</h3>

            <!-- 成功提示 -->
            <div th:if="${successMessage != null}" class="alert alert-success alert-dismissible" id="success-alert">
                <span th:text="${successMessage}"></span>
                <button type="button" class="close" onclick="this.parentElement.style.display='none'">×</button>
            </div>
            
            <script>
                // 页面加载完成后执行
                document.addEventListener('DOMContentLoaded', function() {
                    // 3秒后自动关闭成功提示
                    const successAlert = document.getElementById('success-alert');
                    if (successAlert) {
                        setTimeout(function() {
                            successAlert.style.display = 'none';
                        }, 3000);
                    }
                });
            </script>

            <form th:action="@{/customers/{id}(id=${customer.id})}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <div class="form-row">
                    <div class="form-group">
                        <label>姓名</label>
                        <input type="text" name="name" th:value="${customer.name}" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>电话号码</label>
                        <input type="text" name="phone" th:value="${customer.phone}" class="form-control" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>公积金</label>
                        <input type="text" name="housingFund" th:value="${customer.housingFund}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>营业执照</label>
                        <input type="text" name="businessLicense" th:value="${customer.businessLicense}" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>打卡工资</label>
                        <input type="text" name="salary" th:value="${customer.salary}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>房产</label>
                        <input type="text" name="property" th:value="${customer.property}" class="form-control">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>车产</label>
                        <input type="text" name="carProperty" th:value="${customer.carProperty}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>当前阶段</label>
                        <select name="processStatus" class="form-control">
                            <option th:each="status : ${processStatuses}" 
                                    th:value="${status}" 
                                    th:text="${status.getChineseName()}" 
                                    th:selected="${customer.processStatus == status}">
                            </option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>下次跟进时间</label>
                        <input type="date" name="nextFollowUpDate" th:value="${customer.nextFollowUpDate}" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>负责员工</label>
                        <div class="readonly-field" th:text="${customer.user != null ? customer.user.name : '未分配'}"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>备注</label>
                    <textarea name="remarks" class="form-control" rows="4" th:text="${customer.remarks}"></textarea>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">保存修改</button>
                    <button type="button" class="btn btn-danger" id="delete-btn" th:data-id="${customer.id}">删除客户</button>
                    <a href="/customers" class="btn btn-secondary">返回列表</a>
                </div>
            </form>
            
            <!-- 用于存储CSRF令牌的隐藏字段 -->
            <input type="hidden" id="csrf-token" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const deleteBtn = document.getElementById('delete-btn');
                    deleteBtn.addEventListener('click', function() {
                        // 隐藏之前可能存在的成功提示
                        const successAlert = document.getElementById('success-alert');
                        if (successAlert) {
                            successAlert.style.display = 'none';
                        }
                        
                        const id = this.getAttribute('data-id');
                        if (confirm('确定要删除此客户吗？')) {
                            const form = document.createElement('form');
                            form.method = 'POST';
                            form.action = `/customers/${id}/delete`;
                            
                            // 创建CSRF令牌输入字段
                            const csrfTokenInput = document.createElement('input');
                            csrfTokenInput.type = 'hidden';
                            csrfTokenInput.name = document.getElementById('csrf-token').name;
                            csrfTokenInput.value = document.getElementById('csrf-token').value;
                            form.appendChild(csrfTokenInput);
                            
                            document.body.appendChild(form);
                            form.submit();
                        }
                    });
                });
            </script>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h3>流程详情</h3>
            </div>
            <div class="card-body">
                <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
                    <div class="status-badge status-wechat" th:classappend="${customer.processStatus == 'WECHAT' ? 'active' : ''}">
                        微信
                    </div>
                    <span style="font-size: 20px; color: #ccc;">→</span>
                    <div class="status-badge status-arrived" th:classappend="${customer.processStatus == 'ARRIVED' ? 'active' : ''}">
                        到店
                    </div>
                    <span style="font-size: 20px; color: #ccc;">→</span>
                    <div class="status-badge status-signed" th:classappend="${customer.processStatus == 'SIGNED' ? 'active' : ''}">
                        签单
                    </div>
                    <span style="font-size: 20px; color: #ccc;">→</span>
                    <div class="status-badge status-approved" th:classappend="${customer.processStatus == 'APPROVED' ? 'active' : ''}">
                        审批
                    </div>
                    <span style="font-size: 20px; color: #ccc;">→</span>
                    <div class="status-badge status-loaned" th:classappend="${customer.processStatus == 'LOANED' ? 'active' : ''}">
                        放款
                    </div>
                </div>
            </div>
        </div>
    </div>




</body>
</html>