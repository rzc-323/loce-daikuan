<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款客户管理系统 - 客户公海</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="/">贷款CRM系统</a>
            <ul class="navbar-nav">
                <li><a href="/">首页</a></li>
                <li><a href="/customers">客户列表</a></li>
                <li><a href="/customers/add">添加客户</a></li>
                <th:block th:if="${currentUser.role.name() == 'ADMIN'}">
                    <li><a href="/admin/users">员工管理</a></li>
                    <li><a href="/customer-pool">客户公海</a></li>
                </th:block>
                <li>
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="logout-btn">退出登录</button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <!-- CSRF令牌，供JavaScript使用 -->
        <input type="hidden" id="csrf-token" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div class="card">
            <div class="card-header">
                <h3>客户公海</h3>
            </div>
            <div class="card-body">
                <!-- 成功提示 -->
                <div th:if="${successMessage != null}" class="alert alert-success alert-dismissible" id="success-alert">
                    <span th:text="${successMessage}"></span>
                    <button type="button" class="close" onclick="this.parentElement.style.display='none'">×</button>
                </div>
                
                <script>
                    // 页面加载完成后执行
                    document.addEventListener('DOMContentLoaded', function() {
                        // 3秒后自动关闭成功提示
                        const successAlert = document.getElementById('success-alert');
                        if (successAlert) {
                            setTimeout(function() {
                                successAlert.style.display = 'none';
                            }, 3000);
                        }
                        
                        // 全选/取消全选功能
                        const selectAllCheckbox = document.getElementById('select-all');
                        const customerCheckboxes = document.querySelectorAll('.customer-checkbox');
                        
                        selectAllCheckbox.addEventListener('click', function() {
                            customerCheckboxes.forEach(checkbox => {
                                checkbox.checked = selectAllCheckbox.checked;
                            });
                        });
                        
                        // 单个复选框点击时更新全选状态
                        customerCheckboxes.forEach(checkbox => {
                            checkbox.addEventListener('click', function() {
                                selectAllCheckbox.checked = Array.from(customerCheckboxes).every(cb => cb.checked);
                            });
                        });
                        
                        // 批量分配按钮点击事件
                        const batchAssignBtn = document.getElementById('batch-assign-btn');
                        if (batchAssignBtn) {
                            batchAssignBtn.addEventListener('click', function() {
                                const selectedIds = getSelectedCustomerIds();
                                if (selectedIds.length === 0) {
                                    alert('请至少选择一个客户');
                                    return;
                                }
                                
                                const assigneeId = document.getElementById('batch-assignee').value;
                                if (!assigneeId) {
                                    alert('请选择分配用户');
                                    return;
                                }
                                
                                if (confirm(`确定要将选中的 ${selectedIds.length} 个客户分配给所选用户吗？`)) {
                                    const form = document.createElement('form');
                                    form.method = 'post';
                                    form.action = '/customer-pool/batch-assign';
                                    
                                    // 添加CSRF令牌
                                    const csrfTokenInput = document.getElementById('csrf-token');
                                    if (csrfTokenInput) {
                                        const csrfInput = document.createElement('input');
                                        csrfInput.type = 'hidden';
                                        csrfInput.name = csrfTokenInput.name;
                                        csrfInput.value = csrfTokenInput.value;
                                        form.appendChild(csrfInput);
                                    }
                                    
                                    selectedIds.forEach(id => {
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = 'customerIds';
                                        input.value = id;
                                        form.appendChild(input);
                                    });
                                    
                                    const assigneeInput = document.createElement('input');
                                    assigneeInput.type = 'hidden';
                                    assigneeInput.name = 'userId';
                                    assigneeInput.value = assigneeId;
                                    form.appendChild(assigneeInput);
                                    
                                    document.body.appendChild(form);
                                    form.submit();
                                }
                            });
                        }
                        
                        // 批量删除按钮点击事件
                        const batchDeleteBtn = document.getElementById('batch-delete-btn');
                        if (batchDeleteBtn) {
                            batchDeleteBtn.addEventListener('click', function() {
                                const selectedIds = getSelectedCustomerIds();
                                if (selectedIds.length === 0) {
                                    alert('请至少选择一个客户');
                                    return;
                                }
                                
                                if (confirm(`确定要删除选中的 ${selectedIds.length} 个客户吗？此操作不可恢复！`)) {
                                    const form = document.createElement('form');
                                    form.method = 'post';
                                    form.action = '/customer-pool/batch-delete';
                                    
                                    // 添加CSRF令牌
                                    const csrfTokenInput = document.getElementById('csrf-token');
                                    if (csrfTokenInput) {
                                        const csrfInput = document.createElement('input');
                                        csrfInput.type = 'hidden';
                                        csrfInput.name = csrfTokenInput.name;
                                        csrfInput.value = csrfTokenInput.value;
                                        form.appendChild(csrfInput);
                                    }
                                    
                                    selectedIds.forEach(id => {
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = 'customerIds';
                                        input.value = id;
                                        form.appendChild(input);
                                    });
                                    
                                    document.body.appendChild(form);
                                    form.submit();
                                }
                            });
                        }
                        
                        // 获取选中的客户ID
                        function getSelectedCustomerIds() {
                            const selectedIds = [];
                            customerCheckboxes.forEach(checkbox => {
                                if (checkbox.checked) {
                                    selectedIds.push(checkbox.value);
                                }
                            });
                            return selectedIds;
                        }
                    });
                </script>
                
                <div th:if="${customers.isEmpty()}">
                    <p>客户公海中没有客户</p>
                </div>
                <div th:unless="${customers.isEmpty()}">
                    <!-- 批量操作区域 -->
                    <div class="batch-operations" style="margin-bottom: 15px;">
                        <select id="batch-assignee" style="padding: 5px; margin-right: 10px;">
                            <option value="">选择分配用户</option>
                            <option th:each="user : ${allUsers}" th:value="${user.id}" th:text="${user.name}"></option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="batch-assign-btn">批量分配</button>
                        <button type="button" class="btn btn-danger" id="batch-delete-btn">批量删除</button>
                    </div>
                    
                    <table class="table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all"></th>
                                <th>姓名</th>
                                <th>电话号码</th>
                                <th>当前阶段</th>
                                <th>下次跟进时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="customer : ${customers}">
                                <td><input type="checkbox" class="customer-checkbox" th:value="${customer.id}"></td>
                                <td th:text="${customer.name}"></td>
                                <td th:text="${customer.phone}"></td>
                                <td>
                                    <span th:class="|status-badge status-${customer.processStatus.name().toLowerCase()}|" 
                                          th:text="${customer.processStatus.getChineseName()}"></span>
                                </td>
                                <td th:text="${customer.nextFollowUpDate != null ? #temporals.format(customer.nextFollowUpDate, 'yyyy-MM-dd') : '-'}"></td>
                                <td>
                                    <a th:href="@{/customers/{id}(id=${customer.id})}" class="btn btn-primary">查看详情</a>
                                    <form th:action="@{/customer-pool/assign}" method="post" style="display: inline;">
                                        <input type="hidden" name="customerId" th:value="${customer.id}">
                                        <select name="userId" required style="padding: 5px; margin: 0 5px;">
                                            <option value="">选择分配用户</option>
                                            <option th:each="user : ${allUsers}" th:value="${user.id}" th:text="${user.name}"></option>
                                        </select>
                                        <button type="submit" class="btn btn-secondary">分配</button>
                                    </form>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 分页控件 -->
                <div class="pagination-container">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                        <!-- 每页条数选择器 -->
                        <div style="display: flex; align-items: center;">
                            <span>每页显示:</span>
                            <form th:action="@{/customer-pool}" method="get" style="display: inline; margin-left: 10px;">
                                <select name="size" onchange="this.form.submit()" style="padding: 5px;">
                                    <option th:each="s : ${sizes}" 
                                            th:value="${s}" 
                                            th:selected="${s == pageSize}" 
                                            th:text="${s}"></option>
                                </select>
                                <input type="hidden" name="page" value="0" />
                            </form>
                        </div>
                        
                        <!-- 分页信息 -->
                        <div>
                            共 <span th:text="${totalItems}"></span> 条记录，第 <span th:text="${currentPage + 1}"></span>/<span th:text="${totalPages}"></span> 页
                        </div>
                        
                        <!-- 分页按钮 -->
                        <div>
                            <form th:action="@{/customer-pool}" method="get" style="display: inline;">
                                <input type="hidden" name="size" th:value="${pageSize}" />
                                <button type="submit" name="page" th:value="${currentPage - 1}" 
                                        th:disabled="${currentPage == 0}" 
                                        class="btn btn-secondary">
                                    上一页
                                </button>
                            </form>
                            
                            <!-- 页码按钮 -->
                            <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}">
                                <form th:action="@{/customer-pool}" method="get" style="display: inline;">
                                    <input type="hidden" name="size" th:value="${pageSize}" />
                                    <button type="submit" name="page" th:value="${i}" 
                                            th:class="|btn ${i == currentPage ? 'btn-primary' : 'btn-secondary'}|" 
                                            style="margin: 0 2px;">
                                        <span th:text="${i + 1}"></span>
                                    </button>
                                </form>
                            </th:block>
                            
                            <form th:action="@{/customer-pool}" method="get" style="display: inline;">
                                <input type="hidden" name="size" th:value="${pageSize}" />
                                <button type="submit" name="page" th:value="${currentPage + 1}" 
                                        th:disabled="${currentPage == totalPages - 1}" 
                                        class="btn btn-secondary">
                                    下一页
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>