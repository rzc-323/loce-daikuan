<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>贷款客户管理系统 - 员工管理</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="/">贷款CRM系统</a>
            <ul class="navbar-nav">
                <li><a href="/">首页</a></li>
                <li><a href="/customers">客户列表</a></li>
                <li><a href="/customers/add">添加客户</a></li>
                <th:block th:if="${currentUser.role.name() == 'ADMIN'}">
                    <li><a href="/admin/users">员工管理</a></li>
                </th:block>
                <li>
                    <form th:action="@{/logout}" method="post" style="display: inline;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                        <button type="submit" class="logout-btn">退出登录</button>
                    </form>
                </li>
            </ul>
        </div>
    </nav>
    
    <div class="container">
        <!-- CSRF令牌，供JavaScript使用 -->
        <input type="hidden" id="csrf-token" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>员工管理</h3>
            <a href="/admin/users/add" class="btn btn-success">添加员工</a>
        </div>
        
        <div class="card">
            <div class="card-body">
                <!-- 批量操作区域 -->
                <div class="batch-operations" style="margin-bottom: 15px;">
                    <button type="button" class="btn btn-danger" id="batch-delete-btn">批量删除</button>
                </div>
                
                <table class="table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all"></th>
                            <th>用户名</th>
                            <th>姓名</th>
                            <th>电话号码</th>
                            <th>角色</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="user : ${users}">
                            <td><input type="checkbox" class="user-checkbox" th:value="${user.id}"></td>
                            <td th:text="${user.username}"></td>
                            <td th:text="${user.name}"></td>
                            <td th:text="${user.phone}"></td>
                            <td th:text="${user.role.name()}"></td>
                            <td>
                            <a th:href="@{/admin/users/edit/{id}(id=${user.id})}" class="btn btn-warning">编辑</a>
                            <form th:action="@{/admin/users/delete/{id}(id=${user.id})}" method="post" style="display: inline;">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                                <button type="submit" class="btn btn-danger" onclick="return confirm('确定要删除该员工吗？')">删除</button>
                            </form>
                        </td>
                        </tr>
                    </tbody>
                </table>
                
                <script>
                    // 页面加载完成后执行
                    document.addEventListener('DOMContentLoaded', function() {
                        // 全选/取消全选功能
                        const selectAllCheckbox = document.getElementById('select-all');
                        const userCheckboxes = document.querySelectorAll('.user-checkbox');
                        
                        selectAllCheckbox.addEventListener('click', function() {
                            userCheckboxes.forEach(checkbox => {
                                checkbox.checked = selectAllCheckbox.checked;
                            });
                        });
                        
                        // 单个复选框点击时更新全选状态
                        userCheckboxes.forEach(checkbox => {
                            checkbox.addEventListener('click', function() {
                                selectAllCheckbox.checked = Array.from(userCheckboxes).every(cb => cb.checked);
                            });
                        });
                        
                        // 批量删除按钮点击事件
                        const batchDeleteBtn = document.getElementById('batch-delete-btn');
                        if (batchDeleteBtn) {
                            batchDeleteBtn.addEventListener('click', function() {
                                const selectedIds = getSelectedUserIds();
                                if (selectedIds.length === 0) {
                                    alert('请至少选择一个员工');
                                    return;
                                }
                                
                                if (confirm(`确定要删除选中的 ${selectedIds.length} 个员工吗？此操作不可恢复！`)) {
                                    const form = document.createElement('form');
                                    form.method = 'post';
                                    form.action = '/admin/users/batch-delete';
                                    
                                    // 添加CSRF令牌
                                    const csrfTokenInput = document.getElementById('csrf-token');
                                    if (csrfTokenInput) {
                                        const csrfInput = document.createElement('input');
                                        csrfInput.type = 'hidden';
                                        csrfInput.name = csrfTokenInput.name;
                                        csrfInput.value = csrfTokenInput.value;
                                        form.appendChild(csrfInput);
                                    }
                                    
                                    selectedIds.forEach(id => {
                                        const input = document.createElement('input');
                                        input.type = 'hidden';
                                        input.name = 'userIds';
                                        input.value = id;
                                        form.appendChild(input);
                                    });
                                    
                                    document.body.appendChild(form);
                                    form.submit();
                                }
                            });
                        }
                        
                        // 获取选中的用户ID
                        function getSelectedUserIds() {
                            const selectedIds = [];
                            userCheckboxes.forEach(checkbox => {
                                if (checkbox.checked) {
                                    selectedIds.push(checkbox.value);
                                }
                            });
                            return selectedIds;
                        }
                    });
                </script>
            </div>
        </div>
    </div>
</body>
</html>